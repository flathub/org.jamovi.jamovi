{
    "app-id": "org.jamovi.jamovi",
    "runtime": "org.freedesktop.Platform",
    "runtime-version": "1.6",
    "base": "org.electronjs.Electron2.BaseApp",
    "base-version": "stable",
    "sdk": "org.freedesktop.Sdk",
    "command": "jamovi",
    "separate-locales": false,
    "sdk-extensions": [
        "org.freedesktop.Sdk.Extension.gfortran-62"
    ],
    "rename-desktop-file": "jamovi.desktop",
    "rename-icon": "jamovi",
    "finish-args":[
        "--share=network",
        "--share=ipc",
        "--socket=x11",
        "--socket=pulseaudio",
        "--device=dri",
        "--filesystem=home",
        "--env=TMPDIR=/var/tmp",
        "--talk-name=org.freedesktop.Notifications"
    ],
    "build-options": {
        "cflags": "-O2",
        "cxxflags": "-O2",
        "env": {
            "PATH": "/app/bin:/usr/bin:/usr/lib/sdk/gfortran-62/bin",
            "R_HOME": "/app/lib/R"
        }
    },
    "cleanup": [
        "/include",
        "/bin/chardetect",
        "/bin/cygdb",
        "/bin/cython",
        "/bin/cythonize",
        "/bin/nanocat",
        "/lib/cmake",
        "/lib/debug",
        "/lib/pkgconfig",
        "/lib/*.a",
        "/lib/*.la"
    ],
    "modules":[
        {
            "name": "gfortran",
            "buildsystem": "simple",
            "build-commands": [ "/usr/lib/sdk/gfortran-62/install.sh" ]
        },
        {
            "name": "boost",
            "buildsystem": "simple",
            "build-commands": [
                "./bootstrap.sh --with-libraries=filesystem,system",
                "./b2 -j4 install --prefix=/app"
            ],
            "sources": [
                {
                    "type": "archive",
                    "url": "https://dl.bintray.com/boostorg/release/1.66.0/source/boost_1_66_0.tar.bz2",
                    "sha256": "5721818253e6a0989583192f96782c4a98eb6204965316df9f5ad75819225ca9"
                }
            ],
            "cleanup": [
                "/include"
            ]
        },
        {
            "name": "lapack",
            "buildsystem": "cmake",
            "builddir": true,
            "config-opts": [
                "-DCMAKE_INSTALL_PREFIX=/app",
                "-DCMAKE_INSTALL_LIBDIR=lib",
                "-DCMAKE_BUILD_TYPE=Release",
                "-DBUILD_SHARED_LIBS=ON",
                "-DBUILD_TESTING=OFF",
                "-DCMAKE_Fortran_COMPILER=/usr/lib/sdk/gfortran-62/bin/gfortran",
                "-DLAPACKE=ON",
                "-DCBLAS=ON"
            ],
            "sources": [
                {
                    "type": "archive",
                    "url": "http://www.netlib.org/lapack/lapack-3.8.0.tar.gz",
                    "sha512": "17786cb7306fccdc9b4a242de7f64fc261ebe6a10b6ec55f519deb4cb673cb137e8742aa5698fd2dc52f1cd56d3bd116af3f593a01dcf6770c4dcc86c50b2a7f"
                }
            ],
            "cleanup": [ "/lib/cmake" ]
        },
        {
            "name": "R",
            "config-opts": [
                "--enable-R-shlib",
                "--disable-BLAS-shlib",
                "--libdir=/app/lib"
            ],
            "build-options": {
                "ldflags": "-L/usr/lib/sdk/gfortran-62/lib",
                "env": {
                    "FC": "/usr/lib/sdk/gfortran-62/bin/gfortran",
                    "F77": "/usr/lib/sdk/gfortran-62/bin/gfortran"
                }
            },
            "sources": [
                {
                    "type":"archive",
                    "url": "https://cran.r-project.org/src/base/R-3/R-3.5.1.tar.gz",
                    "sha512":"382cc6e200469dd168799948edcf3a0b869d7ef3b3176fdfc60752f3f37e6ba356323c47d8815a4d9ab6ad3a21cd045d26ef5e75107c8685328e0ffcfd172f7f"
                }
            ],
            "cleanup": [
                "/app/lib/R/doc"
            ]
        },
        {
            "name": "nlopt",
            /* needed by nloptr (R package) */
            "build-options": {
                "cflags": "-fPIC"
            },
            "sources": [
                {
                    "type":"archive",
                    "url": "http://ab-initio.mit.edu/nlopt/nlopt-2.4.2.tar.gz",
                    "sha256":"8099633de9d71cbc06cd435da993eb424bbcdbded8f803cdaa9fb8c6e09c8e89"
                }
            ]
        },
        {
            "name": "ProtoBuf",
            "sources": [
                {
                    "type": "archive",
                    "url": "https://github.com/google/protobuf/releases/download/v3.5.1/protobuf-all-3.5.1.tar.gz",
                    "sha256": "72d43863f58567a9ea2054671fdb667867f9cf7865df623c7be630978ff97dff"
                }
            ],
            "cleanup": [
                "/bin/protoc"
            ]
        },
        {
            "name": "nanomsg",
            /* needed by python3-nanomsg */
            "sources": [
                {
                    "type": "archive",
                    "url": "https://github.com/nanomsg/nanomsg/archive/1.1.2.tar.gz",
                    "sha256": "3c52165a735c2fb597d2306593ae4b17900688b90113d4115ad8480288f28ccb"
                }
            ]
        },
        {
            "name": "nodejs",
            "sources": [
                {
                    "type": "archive",
                    "url": "https://nodejs.org/dist/v8.9.4/node-v8.9.4.tar.gz",
                    "sha256": "729b44b32b2f82ecd5befac4f7518de0c4e3add34e8fe878f745740a66cbbc01"
                }
            ],
            "cleanup": [
                "/include",
                "/share",
                "/lib/node_modules",
                "/bin/node",
                "/bin/npm",
                "/bin/npx"
            ]
        },
        {
            "name": "cpython",
            "sources": [
                {
                    "type": "archive",
                    "url": "https://www.python.org/ftp/python/3.7.1/Python-3.7.1.tar.xz",
                    "sha512": "3eb62a0127609b14420a47442727702f396519c649625aca59883d04f4c02e5f37ba1d58ac8e93c49d14a63f17ae7909315c33fc813293dbcdb6127f39a148b0"
                }
            ],
            "cleanup": [
                "/bin/2to3",
                "/bin/2to3-3.7",
                "/bin/easy_install-3.7",
                "/bin/f2py3",
                "/bin/f2py3.7",
                "/bin/idle3",
                "/bin/idle3.7",
                "/bin/pip3",
                "/bin/pip3.7",
                "/bin/pydoc3",
                "/bin/pydoc3.7",
                "/bin/python3-config",
                "/bin/python3.7-config",
                "/bin/python3.7m",
                "/bin/python3.7m-config",
                "/bin/pyvenv",
                "/bin/pyvenv-3.7"
            ]
        },
        "python-deps.json",
        {
            "name": "python3-numpy",
            "buildsystem": "simple",
            "build-commands": [
                "python3 setup.py build -j 0",
                "python3 setup.py install --prefix=/app --root=/ --optimize=1"
            ],
            "build-options": {
                "env": {
                    "ATLAS": "None",
                    "BLAS": "/app/lib",
                    "LAPACK": "/app/lib"
                }
            },
            "sources": [
                {
                    "type": "archive",
                    "url": "https://files.pythonhosted.org/packages/45/ba/2a781ebbb0cd7962cc1d12a6b65bd4eff57ffda449fdbbae4726dc05fbc3/numpy-1.15.2.zip",
                    "sha512": "6a2c9c5e67963558749e6468d79c7dc55f13749400640dbb7dea8c87a30c9cadb04df6b3cf3f92ac7d720486ef3f3c248ab4680b954e7adeb44edf2f2a072250"
                }
            ]
        },
        {
            "name": "python3-scipy",
            "buildsystem": "simple",
            "build-commands": [
                "python3 setup.py build -j 0",
                "python3 setup.py install --prefix=/app --root=/ --optimize=1"
            ],
            "build-options": {
                "env": {
                    "ATLAS": "None",
                    "BLAS": "/app/lib",
                    "LAPACK": "/app/lib",
                    "LDFLAGS": "-shared"
                }
            },
            "sources": [
                {
                    "type": "archive",
                    "url": "https://files.pythonhosted.org/packages/07/76/7e844757b9f3bf5ab9f951ccd3e4a8eed91ab8720b0aac8c2adcc2fdae9f/scipy-1.1.0.tar.gz",
                    "sha512": "72fe32c6c009613cb78202598e5db14f8e630b3218839cfe18d43d40550d94cc5aa100c6f5d41f40e86ae148e9b6a13431bb91b0f9be44b0569ccd7b725fe973"
                }
            ]
        },
        {
            "name": "electron-x86_64",
            "only-arches": [ "x86_64" ],
            "buildsystem": "simple",
            "build-commands": [
                "mkdir -p /app/bin/resources",
                "cp *.so  /app/bin",
                "cp *.bin /app/bin",
                "cp *.dat /app/bin",
                "cp *.pak /app/bin",
                "cp electron /app/bin/",
                "cp -r resources/ /app/bin/"
            ],
            "sources": [
                {
                    "type": "archive",
                    "url": "https://github.com/electron/electron/releases/download/v3.0.4/electron-v3.0.4-linux-x64.zip",
                    "sha512": "9e0febf884f652bc0b33088c87de4eba197e92283526e31ec3c51d649cf029da1b32d6fe5588acaa4420b8f74ea4f7e68ddf125f2c3b457eabbf766119212e76",
                    "strip-components": 0
                }
            ]
        },
        {
            "name": "electron-i386",
            "only-arches": [ "i386" ],
            "buildsystem": "simple",
            "build-commands": [
                "mkdir -p /app/bin/resources",
                "cp *.so  /app/bin",
                "cp *.bin /app/bin",
                "cp *.dat /app/bin",
                "cp *.pak /app/bin",
                "cp electron /app/bin/",
                "cp -r resources/ /app/bin/"
            ],
            "sources": [
                {
                    "type": "archive",
                    "url": "https://github.com/electron/electron/releases/download/v3.0.4/electron-v3.0.4-linux-ia32.zip",
                    "sha512": "0b9d297718c45215ddf5ec26e174435c90537e10fd84356f1e0c398b2d3acbc0aca003322d6748111f1b45923f9ebecd02e58843eca9ec1a3268ecd7702792e9",
                    "strip-components": 0
                }
            ]
        },
        {
            "name": "electron-arm",
            "only-arches": [ "arm" ],
            "buildsystem": "simple",
            "build-commands": [
                "mkdir -p ${FLATPAK_DEST}/bin/resources",
                "cp *.so  ${FLATPAK_DEST}/bin",
                "cp *.bin ${FLATPAK_DEST}/bin",
                "cp *.dat ${FLATPAK_DEST}/bin",
                "cp *.pak ${FLATPAK_DEST}/bin",
                "cp electron ${FLATPAK_DEST}/bin/",
                "cp -r resources/ ${FLATPAK_DEST}/bin/"
            ],
            "sources": [
                {
                    "type": "archive",
                    "url": "https://github.com/electron/electron/releases/download/v3.0.4/electron-v3.0.4-linux-armv7l.zip",
                    "sha512": "44843381e650c77a49da4262e5f274cd6db91deb669c5d2038e5c635d1842fa9abf766169eb732e14716cc48a227154588ce52ecb86d5502fbf29d35429a990f",
                    "strip-components": 0
                }
            ]
        },
        {
            "name": "electron-arm64",
            "only-arches": [ "aarch64" ],
            "buildsystem": "simple",
            "build-commands": [
                "mkdir -p ${FLATPAK_DEST}/bin/resources",
                "cp *.so  ${FLATPAK_DEST}/bin",
                "cp *.bin ${FLATPAK_DEST}/bin",
                "cp *.dat ${FLATPAK_DEST}/bin",
                "cp *.pak ${FLATPAK_DEST}/bin",
                "cp electron ${FLATPAK_DEST}/bin/",
                "cp -r resources/ ${FLATPAK_DEST}/bin/"
            ],
            "sources": [
                {
                    "type": "archive",
                    "url": "https://github.com/electron/electron/releases/download/v3.0.4/electron-v3.0.4-linux-arm64.zip",
                    "sha512": "7e0bde12d3b2e1ea8ee7545239092d786cf84b9e411a047c19e0188bc0a500eb6574ef9c60a4f26e2abce7fb3d823baa5947c09c4df6b052c153a07c7da7dcc2",
                    "strip-components": 0
                }
            ]
        },
        {
            "name": "jmvcore",
            "buildsystem": "simple",
            "build-commands": [
                "/app/bin/R CMD INSTALL *.Rpkg  --no-docs --no-html --no-help --no-demo --no-multiarch",
                "/app/bin/R CMD INSTALL jmvcore --no-docs --no-html --no-help --no-demo --no-multiarch"
            ],
            "build-options": {
                "env": {
                    "PATH": "/app/bin:/usr/bin:/usr/lib/sdk/gfortran-62/bin"
                }
            },
            "sources": [
                {
                    "type": "script",
                    "dest-filename": "xml2-config",
                    /* providing our own xml2-config saves us from having to */
                    /* patch a *lot* of packages */
                    "commands": [
                        "#!/bin/bash",
                        "if [ \"$1\" == \"--version\" ]",
                        "then",
                        "    pkg-config --modversion libxml-2.0",
                        "else",
                        "    pkg-config $* libxml-2.0",
                        "fi"
                    ]
                },
                {
                        "type": "shell",
                        "commands": [
                            "mv xml2-config /app/bin"
                        ]
                },
                "base-deps-sources.json",
                "jamovi-source.json"
            ],
            "cleanup": [
                "/bin/xml2-config"
            ]
        },
        {
            "name": "jamovi-electron-app",
            "buildsystem": "simple",
            "build-options": {
                "env": {
                    "npm_config_cache": "../npm-cache"
                }
            },
            "build-commands": [
                "cp jamovi /app/bin/jamovi",
                "cd electron && npm install --offline",
                "cd electron && npm run deploy",
                "mv electron/default_app.asar /app/bin/resources"
            ],
            "sources":[
                "electron-app-deps-sources.json",
                "jamovi-source.json",
                {
                    "type": "script",
                    "dest-filename": "jamovi",
                    /* we handle the call to --version here so it doesn't */
                    /* need electron (or a display server) */
                    "commands": [
                        "#!/bin/bash",
                        "SCRIPT=`realpath $0`",
                        "HERE=`dirname $SCRIPT`",
                        "if [[ \"$1\" == \"--version\" ]]; then",
                        "    cat $HERE/../lib/jamovi/version",
                        "elif [[ \"$1\" == \"-R\" ]]; then",
                        "    shift",
                        "    /app/bin/R \"$@\"",
                        "else",
                        "    $HERE/electron $@",
                        "fi"
                    ]
                }
            ]
        },
        {
            "name": "jamovi-server",
            "buildsystem": "simple",
            "build-commands": [
                "cd server && python3 setup.py build_ext",
                "cd server && python3 setup.py install --prefix=/app",
                "cd readstat && python3 setup.py build_ext",
                "cd readstat && python3 setup.py install --prefix=/app",
                "mkdir -p /app/lib/jamovi",
                "cp -r examples/ /app/lib/jamovi/",
                "cp version /app/lib/jamovi/version"
            ],
            "sources":[
                "jamovi-source.json"
            ]
        },
        {
            "name": "jamovi-client",
            "buildsystem": "simple",
            "build-options": {
                "env": {
                    "npm_config_cache": "../npm-cache"
                }
            },
            "build-commands": [
                "cd client && npm install --offline",
                "cd client && npm run prepublish",
                "mkdir -p              /app/lib/jamovi/client",
                "cp client/*.js        /app/lib/jamovi/client",
                "cp client/*.html      /app/lib/jamovi/client",
                "cp client/*.css       /app/lib/jamovi/client",
                "cp client/favicon.ico /app/lib/jamovi/client",
                "cp -r client/assets   /app/lib/jamovi/client"
            ],
            "sources":[
                "client-deps-sources.json",
                "jamovi-source.json"
            ]
        },
        {
            "name": "env.conf",
            "buildsystem": "simple",
            "build-commands": [
                "sed -E -e \"s|JAMOVI_SERVER_CMD=[A-Za-z0-9_/]+|JAMOVI_SERVER_CMD=/app/bin/python3|g\" -e \"s|R_HOME=.*|R_HOME=$R_HOME|g\" -e \"s|R_LIBS=.*|R_LIBS=$R_HOME/library|g\" env.conf > /app/bin/env.conf"
            ],
            "sources":[
                {
                    "type": "file",
                    "path": "env.conf"
                }
            ]
        },
        {
            "name": "jmv",
            "buildsystem": "simple",
            "build-commands": [
                "mkdir -p /app/lib/jamovi/modules",
                "mkdir -p jmv/build/R",
                "/app/bin/R CMD INSTALL *.Rpkg --library=jmv/build/R --no-docs --no-html --no-data --no-help --no-demo --no-multiarch",
                "cd jamovi-compiler && npm install --offline",
                "./jamovi-compiler.sh --install jmv --to /app/lib/jamovi/modules --home /app"
            ],
            "build-options": {
                "env": {
                    "npm_config_cache": "../npm-cache"
                }
            },
            "sources": [
                "jmc-deps-sources.json",
                "jmv-deps-sources.json",
                "jamovi-source.json",
                {
                    "type": "script",
                    "dest-filename": "xml2-config",
                    /* providing our own xml2-config saves us from having to */
                    /* patch a *lot* of packages */
                    "commands": [
                        "#!/bin/bash",
                        "if [ \"$1\" == \"--version\" ]",
                        "then",
                        "    pkg-config --modversion libxml-2.0",
                        "else",
                        "    pkg-config $* libxml-2.0",
                        "fi"
                    ]
                },
                {
                    "type": "shell",
                    "commands": [
                        "mv xml2-config /app/bin"
                    ]
                },
                {
                    "type": "script",
                    "dest-filename": "jamovi-compiler.sh",
                    "commands": [
                        "node jamovi-compiler/index.js --rhome $R_HOME $*"
                    ]
                }
            ],
            "cleanup": [
                "/bin/xml2-config"
            ]
        },
        {
            "name": "jamovi-engine",
            "build-options": {
                "config-opts": [
                    "--rhome=/app/lib/R",
                    "--base-module-path=/app/lib/R/library",
                    "--rpath=/app/lib/R/library/RInside/lib",
                    "--rpath=/app/lib/R/lib"
                ]
            },
            "sources":[
                "jamovi-source.json"
            ]
        },
        {
            "name": "jamovi-meta",
            "buildsystem": "simple",
            "build-commands": [
                "mkdir -p /app/share/icons/hicolor/scalable/apps",
                "cp platform/app-icon.svg /app/share/icons/hicolor/scalable/apps/jamovi.svg",
                "mkdir -p /app/share/applications",
                "cp platform/jamovi.desktop /app/share/applications/",
                "mkdir -p /app/share/appdata",
                "cp org.jamovi.jamovi.appdata.xml /app/share/appdata/",
                "mkdir -p /app/share/mime/packages",
                "cp platform/jamovi-dataset.xml /app/share/mime/packages/org.jamovi.jamovi.xml"
            ],
            "sources":[
                "jamovi-source.json",
                {
                    "type": "file",
                    "path": "org.jamovi.jamovi.appdata.xml"
                }
            ]
        }
    ]
}
